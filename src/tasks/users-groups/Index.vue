<template>
    <div v-if="$systemFunctions.statusTaskLoaded==1">
        <List/>
        <AddEdit/>
        <Details/>
        <Role/>
    </div>
</template>

<script>
import List from './List.vue'
import AddEdit from './AddEdit.vue'
import Details from './Details.vue'
import Role from './Role.vue'
    export default {
        components: {
            List,
            AddEdit,
            Details,
            Role            
        },

        data (){
            return {
                base_url:'users-groups',
                method:'list',        
                permissions:{},
                itemDefault: {},                
                item: {},           //single item
                items: {data:[]},   //from Laravel server with pagination and info
                itemsFiltered: [],    //for display
                itemsLoaded:false,
                modules_tasks:{},
                columns:{all:{},hidden:[]},
                hidden_columns:[],
                pagination: {current_page: 1,per_page_options: [1,2,3,4,5,10,20,500,1000],per_page:2,show_all_items:true},
                module_task_max_action:8,
            }
        },
        created(){    
            if(!(this.$systemFunctions.user.id>0)){
                return;
            }        
            this.$systemFunctions.loadLanguageFiles([
                {language:this.$systemFunctions.getLanguage(),file:'tasks/'+this.base_url+'/language.js'},
            ]);
            this.init();
        },
        watch: {
            $route(to, from) {
                this.routing(to);                      
            }
        },
        methods: {
            routing:function(route)
            { 
                this.getItems(this.pagination);//Load at least once
                if(route.path=='/'+this.base_url)
                {
                    this.method='list';
                }
                else if(route.path=='/'+this.base_url+'/add')
                {
                    this.method='add';
                    this.addItem();
                }
                else if(route.path.indexOf('/'+this.base_url+'/edit/')!=-1)
                {
                    this.method='edit';        
                    this.editItem(route.params['item_id']);        
                }
                else if(route.path.indexOf('/'+this.base_url+'/details/')!=-1)
                {
                    this.method='details';        
                    this.detailsItem(route.params['item_id']);        
                }
                else if(route.path.indexOf('/'+this.base_url+'/role/')!=-1)
                {
                    this.method='role';        
                    this.roleItem(route.params['item_id']);        
                }
            },
            init(){
                this.$systemFunctions.statusTaskLoaded=0;
                this.$systemFunctions.statusDataLoaded=0;                
                this.$axios.get('/'+this.base_url+'/initialize')
                .then(res=>{                    
                    if(res.data.error==''){
                        // this.setColumnCsv();                        
                        this.permissions=res.data.permissions;
                        this.itemDefault=res.data.itemDefault;
                        this.modules_tasks=res.data.modules_tasks;
                        this.columns.hidden=res.data.hidden_columns;
                        this.setColumns();
                        this.$systemFunctions.statusTaskLoaded=1;
                        this.routing(this.$route);                        
                    }
                    this.$systemFunctions.statusDataLoaded = 1;
                }).catch(error => {  
                    console.log(error);                    
                    this.$systemFunctions.statusDataLoaded = 1;
                    if (error.response && error.response.data && error.response.data.error) {
                        this.$systemFunctions.showResponseError(error.response.data);            
                    } else {            
                        this.$systemFunctions.showResponseFailure();
                    }                              
                });
            },
            setColumns(){
                this.columns.all={};                
                let key='id';
                this.columns.all[key]={
                    label: this.$systemFunctions.getLabel('label_id'),
                    hideable:false,
                    filterable:true,
                    filter:{type:'number',from:'',to:''}
                    };
                
                key='name';
                this.columns.all[key]={
                    label: this.$systemFunctions.getLabel('label_name'),
                    hideable:true,
                    filterable:true,
                    filter:{type:'text',from:'',to:''}
                    };
                key='num_tasks';
                this.columns.all[key]={
                    label: this.$systemFunctions.getLabel('label_num_tasks'),
                    hideable:true,
                    filterable:false                    
                };
                key='ordering';
                this.columns.all[key]={
                    label: this.$systemFunctions.getLabel('label_ordering'),
                    hideable:true,
                    filterable:false                    
                };
                key='status';
                this.columns.all[key]={
                    label: this.$systemFunctions.getLabel('label_status'),
                    hideable:true,
                    filterable:true,
                    filter:{type:'dropdown',from:'',to:'',options:[
                        {value:this.$systemFunctions.dbStatus.ACTIVE,label:this.$systemFunctions.dbStatus.ACTIVE},
                        {value:this.$systemFunctions.dbStatus.INACTIVE,label:this.$systemFunctions.dbStatus.INACTIVE},
                    ]}
                    };
                key='created_at';
                this.columns.all[key]={
                    label: this.$systemFunctions.getLabel('label_created_time'),
                    hideable:true,
                    filterable:true,
                    filter:{type:'date',from:'',to:''}
                    };
            },  
            
            reloadItems(pagination){
                this.itemsLoaded=false;
                this.getItems(pagination);
            },       
            getItems(pagination){                
                if(!this.itemsLoaded)
                {
                    this.$systemFunctions.statusDataLoaded=0;
                    this.$axios.get('/'+this.base_url+'/get-items?page='+ pagination.current_page+'&perPage='+ pagination.per_page)
                    .then(res => {
                        this.$systemFunctions.statusDataLoaded = 1;
                        if(res.data.error==''){
                            this.items=res.data.items;
                            this.getFilteredItems();                                                
                        }
                        this.itemsLoaded=true;
                    }).catch(error => {                      
                        this.$systemFunctions.statusDataLoaded = 1;
                        if (error.response && error.response.data && error.response.data.error) {
                            this.$systemFunctions.showResponseError(error.response.data);            
                        } else {            
                            this.$systemFunctions.showResponseFailure();
                        }                              
                    });
                }                
            }, 
            getFilteredItems:function(){ 
                this.itemsFiltered=this.$systemFunctions.getFilteredItems(this.items.data,this.columns.all);
                for(let i=0;i<this.itemsFiltered.length;i++){
                    this.itemsFiltered[i]['created_at']=this.$systemFunctions.displayTime(this.itemsFiltered[i]['created_at']);
                    this.itemsFiltered[i]['num_tasks']= this.itemsFiltered[i]['action_0'].split(",").length - 2;
                }               
            },            
            addItem(){
                this.$systemFunctions.validationErrors='';
                if(!(this.permissions.action_1))
                {
                    this.$systemFunctions.statusTaskLoaded=-2;
                }
                else
                { 
                    this.item={};
                    Object.assign(this.item, this.itemDefault);           
                }
            },
            setItemByItemId(item_id){
                this.item={};
                //local search
                let items=this.items.data;
                for(let i=0;i<items.length;i++){
                    if(items[i].id==item_id){
                        Object.assign(this.item, items[i]);
                    }                        
                }                    
                //Live Search request
                if(!('id' in this.item)){                        
                    this.$systemFunctions.statusDataLoaded=0;
                    this.$axios.get('/'+this.base_url+'/get-item/'+ item_id)
                    .then(res => {
                        this.$systemFunctions.statusDataLoaded = 1;
                        if(res.data.error==''){
                            this.item={};
                            this.item=res.data.item;                     
                        }
                    }).catch(error => {   
                        this.$systemFunctions.statusDataLoaded = 1;
                        if (error.response && error.response.data && error.response.data.error) {
                            this.$systemFunctions.showResponseError(error.response.data);            
                        } else {            
                            this.$systemFunctions.showResponseFailure();
                        }                              
                    });
                }
            },
            editItem(item_id){
                this.$systemFunctions.validationErrors='';
                if(!(this.permissions.action_2))
                {
                    this.$systemFunctions.statusTaskLoaded=-2;
                }
                else
                {
                    this.setItemByItemId(item_id);                      
                }
            },
            detailsItem(item_id){                
                this.setItemByItemId(item_id);
            },
            roleItem(item_id){                
                if(!(this.permissions.action_2))
                {
                    this.$systemFunctions.statusTaskLoaded=-2;
                }
                else
                {
                    this.setItemByItemId(item_id);
                }
            },
            // assignTask(item){
            //     this.$systemFunctions.validationErrors='';
            //     this.refreshRole=false;
            //     let $this=this;
            //     //settimeout for rerender the div
            //     setTimeout(() => {
            //         $this.refreshRole=true;
            //         $this.item={};
            //         Object.assign($this.item, item);                
            //      }, 1);
                
            // },            
            // saveItem(){
                
            //     this.$systemFunctions.statusDataLoaded=0;
            //     this.$axios.post('/users-groups/save-item',new FormData(document.getElementById('formSave')))
            //     .then(res => {
            //         this.$systemFunctions.statusDataLoaded = 1;
            //         if(res.data.error==''){
            //             this.$systemFunctions.showSuccessMessage(this.$systemFunctions.getLabel('msg_success_saved'));
            //             $('#modalAddEdit').modal('hide');
            //             this.getItems(this.pagination);
            //         }
            //     }).catch(error => {                      
            //         this.$systemFunctions.statusDataLoaded = 1;
            //         if (error.response && error.response.data && error.response.data.error) {
            //             this.$systemFunctions.showResponseError(error.response.data);            
            //         } else {            
            //             this.$systemFunctions.showResponseFailure();
            //         }                              
            //     });
            // },
            // saveRole(form_id){
            //     this.$systemFunctions.statusDataLoaded=0;
            //     this.$axios.post('/users-groups/save-role/'+this.item.id,new FormData(document.getElementById(form_id)))
            //     .then(res => {
            //         this.$systemFunctions.statusDataLoaded = 1;
            //         if(res.data.error==''){                        
            //             this.$systemFunctions.showSuccessMessage(this.$systemFunctions.getLabel('msg_success_saved'));
            //             $('#modalAssignTask').modal('hide');
            //             this.getItems(this.pagination);
            //         }
            //     }).catch(error => {                      
            //         this.$systemFunctions.statusDataLoaded = 1;
            //         if (error.response && error.response.data && error.response.data.error) {
            //             this.$systemFunctions.showResponseError(error.response.data);            
            //         } else {            
            //             this.$systemFunctions.showResponseFailure();
            //         }                              
            //     });

            // },
            
        }

    }
</script>

<style  scoped>

</style>
